Webアプリケーション仕様書：日田市総合案内コンシェルジュ Ver. 2.1

1. アプリ概要

アプリ名： 日田市総合案内コンシェルジュ

目的： 観光と防災におけるタイムパフォーマンスを向上し、ユーザーの利便性を高める。

対象ユーザー： 日田市民、観光客

2. 機能一覧

共通機能

ルート案内・マップ表示：

現在地と目的地のGPS取得。

単一スポットへのルート案内。

複数スポットの最適化経路の算出：

ユーザーが複数の目的地（観光スポット、飲食店、避難所など）を選択した場合、最適な訪問順序を算出し、リストとマップで提示する。（詳細は「5. 主要機能詳細」を参照）

Google Mapリンク機能：

算出された単一または最適化経路を、Google Mapアプリ（またはWeb）で開くための外部リンクを生成する。

Excelからスポットデータ読込（観光・防災）。

現在の天気・気象情報表示。

観光モード

観光地・飲食店をリストとマップで表示（複数選択UIを含む）。

飲食店の待ち時間、混雑状況、営業時間表示（※最適化アルゴリズムの「現在の待ち時間」として利用）。

月別人気観光地ランキング表示。

イベント一覧（ポスターや詳細情報付き）。

GeminiによるAIプラン提案：

ユーザーが予算、時間、興味（例：「歴史」、「自然」、「グルメ」）、同行者（例：「家族連れ」、「一人旅」）などを入力すると、Gemini API (Flash) が日田市のスポット（Excelデータ参照）に基づいた具体的な観光プランを生成・提案する。（詳細は「8. AI機能詳細」を参照）

日田市の交通状況をリストとマップで表示。

防災モード

現在地から最寄り避難所への最短・安全ルート案内。

複数の避難所や防災関連施設（コンビニ、自動販売機）を選択した場合の最適化ルート算出（詳細は「5. 主要機能詳細」を参照）。

ハザードマップ表示。

避難所の混雑状況・収容可能人数をリストとマップで表示。

コンビニ・スーパーの営業状況表示。

自動販売機の位置表示。

予算に応じた防災グッズの提案。

3. データ仕様（Excel読み込み）

ファイル形式： .xlsx（ファイル名：spots.xlsx）

シート名： 「観光」「防災」

カラム構成（観光シート）：

No

スポット名

緯度

経度

所要時間（参考）

説明

カテゴリ: AIプラン提案の参照用（例：「歴史」「自然」「グルメ」「体験」）

カラム構成（防災シート）：

No

スポット名

緯度

経度

所要時間（参考）

説明

読み込み方法： pandasで読み込み、Streamlitでマップ表示やAI提案に活用。

4. UI設計（主な画面）

トップ画面： モード切替、天気情報。

マップ画面：

現在地とスポットの表示。

スポット複数選択機能（リストまたはマップ上のチェックボックス）。

「最適化ルートを算出」ボタン。

スポット詳細画面： 説明、写真、ルート案内（単一）。

最適化ルート表示画面（モーダルまたはポップアップ）：

算出された最適化経路の訪問順リスト（例： 1. A飲食店 → 2. B観光地）。

全体の所要時間（移動時間＋待ち時間＋所要時間）の目安。

「Google Mapで開く」ボタン。

AIプラン提案画面：

APIキー入力欄：

ユーザーが自身のGemini APIキーを入力するテキストボックス (type="password")。

APIキー取得へのリンクを表示： [🔑 Gemini APIキーを取得する →](https://aistudio.google.com/app/apikey)

プラン条件入力欄：

予算、滞在時間、興味カテゴリ（チェックボックス）、同行者などの入力フォーム。

「プラン生成」ボタン。

結果表示エリア：

Geminiが生成したプラン（テキスト）を表示。

プランに含まれるスポットへのリンク（マップ画面または詳細画面へ遷移）。

イベントカレンダー画面： 年間イベントの表示とフィルター。

防災画面： ハザードマップ、避難ルート、混雑情報の可視化。

5. 主要機能詳細：最適化経路の算出

参照アルゴリズム：『最近傍法を応用した最適化順路算出システムの開発』（SOJO 78回生SS情報班 論文）に基づく。

5.1. 観光モード（待ち時間考慮アルゴリズム）

対象： ユーザーが現在地と複数の目的地（飲食店、観光地など）を選択した場合。

目的： 「待ち時間」と「移動距離」の両方を考慮し、タイムパフォーマンスの高い巡回順路を決定する。

アルゴリズム：

未訪問の各スポット i について、以下のスコア Si を算出する。

Si = RW,i + RD,i

RD,i (距離ランキング)：

現在地から各未訪問スポット i までの距離（ヒュベニの公式または緯度経度から算出）に基づき、近い順にランキング（1位, 2位...）を付ける。

RW,i (現在の待ち時間ランキング)：

「現在の待ち時間」（機能一覧（観光モード）で取得するデータ）に基づき、待ち時間が短い順にランキング（1位, 2位...）を付ける。

※「現在の待ち時間」は機能一覧（観光モード）で取得するデータを使用する。

※待ち時間データがないスポット（飲食店以外など）は、RW,i を 0 または中間のランキング値として計算し、距離(RD,i)を優先的に評価する。

次の目的地決定：

合計スコア Si が最小となるスポット i を次の目的地として決定する。

繰り返し：

現在地を決定した目的地に更新し、未訪問スポットがなくなるまで上記1〜4を繰り返す。

5.2. 防災モード（単純最近傍法）

対象： ユーザーが現在地と複数の目的地（避難所、コンビニなど）を選択した場合。

目的： 待ち時間を考慮せず、最短距離で巡回できる順路を決定する。

アルゴリズム：

Si = RD,i のみでスコアを決定する（単純な最近傍法）。

現在地から最も距離が近い未訪問スポットを次の目的地として決定する。

未訪問スポットがなくなるまで繰り返す。

5.3. Google Mapリンク生成

算出された最適化経路（訪問順）に基づき、Google MapのURL（Directions API形式）を生成する。

形式：
https://www.google.com/maps/dir/?api=1&origin=[出発地の緯度,経度]&destination=[最終目的地の緯度,経度]&waypoints=[経由地1の緯度,経度]|[経ytuigyp地2の緯度,経度]|...

最適化された順序で origin, waypoints, destination を設定する。

6. 実装フェーズ（開発手順）

フェーズ1： マップの組み込み

フェーズ2： Excelからの観光・防災スポット読み込みとマップ表示

フェーズ3： 観光機能の実装（イベント表示、混雑情報、ランキングなど ※AIプラン除く）

フェーズ4： 防災機能の実装（避難所ルート、開店情報、ハザードマップなど）

フェーズ5：最適化経路機能の実装

複数スポット選択UI（マップ・リスト）の実装。

距離計算ロジック（ヒュベニの公式等）の実装。

観光モード用アルゴリズム（RW,i + RD,i）の実装。

防災モード用アルゴリズム（RD,i のみ）の実装。

最適化ルート表示UI（モーダル）およびGoogle Mapリンク生成機能の実装。

フェーズ6：AIプラン提案機能の実装

AIプラン提案画面（UI）の作成。

APIキー入力欄と取得リンクの設置。

Gemini API (gemini-2.0-flash-preview-09-2025) との連携処理。

Excelデータ（特にカテゴリ、スポット名、説明）をコンテキストとして利用するプロンプトエンジニアリング。

フェーズ7： UI改善、レスポンシブ対応

7. 使用予定技術

フロントエンド： Python (Streamlit)

データ管理： pandas + Excel

AI： Google Gemini API (gemini-2.0-flash-preview-09-2025)

バージョン管理： GitHub (Excelファイルも含む)

8. AI機能詳細 (Gemini API)

モデル： gemini-2.0-flash-preview-09-2025 を使用する。

APIキーの扱い：

Streamlitのセッションステート（st.session_state）を利用し、ユーザーが入力したAPIキーを一時的に保持する。キーはサーバー側には保存しない。

入力欄は st.text_input("Gemini APIキーを入力してください", type="password") を使用し、キーが画面に表示されないようにする。

APIキー取得リンク：

APIキー入力欄の直下または横に、指定されたURLへのマークダウンリンクを配置する。
st.markdown("[🔑 Gemini APIキーを取得する →](https://aistudio.google.com/app/apikey)")

プロンプト設計（例）：

システムプロンプト： 「あなたは日田市の観光コンシェルジュです。以下の観光スポットリストとユーザーの要望に基づき、魅力的な観光プランを提案してください。」

ユーザープロンプト（入力）：

観光スポットリスト: [Excelから読み込んだスポット名、カテゴリ、説明の簡易リストを文字列として挿入]

ユーザーの要望: 予算[5000円以内], 時間[3時間], 興味[歴史, グルメ], 同行者[一人旅]

期待する出力： （例）「日田市満喫3時間プラン（一人旅・歴史とグルメ）： 1. 豆田町散策（歴史） → 2. ...（グルメ） → 3. ...」